<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Framework Project</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="shortcut icon" href="img/favicon.ico">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
	<link rel="stylesheet" href="/css/apt.css">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js" integrity="sha384-7+zCNj/IqJ95wo16oMtfsKbZ9ccEh31eOz1HGyDuCQ6wgnyJNSYdrPa03rtR1zdB" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js" integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13" crossorigin="anonymous"></script>
</head>
<body>
	<!-- NavBar Start -->
	<nav class="navbar navbar-expand-lg navbar-light bg-light">
	  <div class="container-fluid">
	    <a class="navbar-brand" href="/index">HappyHouse</a>
	    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
	      <span class="navbar-toggler-icon"></span>
	    </button>
	    <div class="collapse navbar-collapse" id="navbarNav">
	      <ul class="navbar-nav">
	        <li class="nav-item" id="login"></li>
	        <li class="nav-item" id="logout"></li>
	        <li class="nav-item">
	          <a class="nav-link" id="NavbtnRegister" style="cursor: pointer">회원가입</a>
	        </li>
	        <li class="nav-item" id="userinfo"></li>
	        <li class="nav-item">
	          <a class="nav-link" id="NavbtnApart" style="cursor: pointer">아파트 검색</a>
	        </li>
	      </ul>
	    </div>
	  </div>
	</nav>
	<!-- NavBar END -->

	<div class="container">
		<div class="card col-sm-12 mt-1" style="min-height: 600px;">
			<div class="card-body">
				<div class="form-group form-inline justify-content-center">
						<label class="mr-2" for="sido">시도 : </label>
						<select class="form-select-sm " id="sido">
							<option value="0">선택</option>
						</select>
						<label class="mr-2 ml-3" for="gugun">구군 : </label>
						<select class="form-select-sm" id="gugun">
							<option value="0">선택</option>
						</select>
						<label class="mr-2 ml-3" for="dong">읍면동 : </label>
						<select class="form-select-sm" id="dong">
							<option value="0">선택</option>
						</select>
					
					
					<label class="mr-2 ml-3" for="aptKeyword">아파트명 : </label>
					<input type="text" id ="aptKeyword"/>
					<button type="button" id="btnAptSearch" class="class="mr-2 ml-3"> 검색</button>
					
					<!-- 정렬하기와 한 페이지 최대 개수 추가 -->
				</div>
				<table class="table mt-2 table-striped">
					<colgroup>
						<col width="100">
						<col width="180">
						<col width="*">
						<col width="120">
						<col width="120">
					</colgroup>	
					<thead>
						<tr>
							<th>번호</th>
							<th>아파트이름</th>
							<th class="text-center">주소</th>
							<th>건축연도</th>
							<th>최근거래금액</th>
						</tr>
					</thead>
					<tbody id="searchResult"></tbody>
				</table>
			</div>
		</div>
	</div>
	
<div id="paginationWrapper"></div>   	
	
<!-- Modal -->
<div class="modal fade" id="modalApartDetail" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalApartDetailTitle">아파트 상세 정보</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
      	<div class="row" id="divApartInfo">
      	  
      	</div>
      	<div class="row">
<!--       	  <div class="col-3 scrollspy-example" id="divApartDealScroll" data-bs-spy="scroll"> -->
<!-- 	      	스크롤과 거래내역 -->
<!-- 	      </div> -->
	      <div class="col-9">
	      	<div id="map" style="width:100%;height:300px;"></div>
	      </div>
      	</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="btnUserInterestApart">관심 아파트 등록</button>
      </div>
    </div>
  </div>
</div>	
	<script src="/js/navbar.js"></script>	
	<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=a8f020994a96fc4cd4e8374ac86e3ac9&libraries=services"></script>
	<script type="text/javascript" src="js/map.js"></script>
	<script type="text/javascript" src="js/util.js"></script>
	<script type="text/javascript">
	var LIST_ROW_COUNT = 10;	//limit
	var OFFSET = 0;
	var PAGE_LINK_COUNT = 10;	// pagination link 갯수
	var TOTAL_LIST_ITEM_COUNT = 0;
	var CURRENT_PAGE_INDEX = 1;
	
	window.onload = function(){
		
		navBar();
		
		getSido();
		document.querySelector("#sido").onchange = getGugun;
		document.querySelector("#gugun").onchange = getDong;
		document.querySelector("#dong").onchange = function(){
			OFFSET = 0;
			CURRENT_PAGE_INDEX = 1;
			getSearchResult();
		};
		
		document.querySelector("#btnAptSearch").onclick = function(){
			OFFSET = 0;
			CURRENT_PAGE_INDEX = 1;
			getSearchResult();
		};
	};
	
	async function getSido(){
		let url = "/address/sido"
		
		let response = await fetch(url);
		let data = await response.json();
		
		let sidoHTML = document.querySelector("#sido");
		let optionHTML = ``;
		
		data.forEach(el => {
			optionHTML += `<option value=${el.sidoCode}>${el.sidoName}</option>`

		});
		sidoHTML.options.length = 1;
		sidoHTML.innerHTML += optionHTML;
		
	};
	
	async function getGugun(){
		let gugunHTML = document.querySelector("#gugun");
		gugunHTML.options.length = 1;
		document.querySelector("#dong").options.length = 1;
		
		let sidoValue = document.querySelector("#sido").value;
		
		if(sidoValue == "0" ){
			document.querySelector("#searchResult").innerHTML = "";
			return;
		}
		
		let url = "/address/gugun/" + sidoValue;
		
		let response = await fetch(url);
		let data = await response.json();
		
		console.log(data);
		
		let optionHTML = ``;
		
		data.forEach(el => {
			optionHTML += `<option value=${el.gugunCode}>${el.gugunName}</option>`

		});
		
		gugunHTML.innerHTML += optionHTML;
		
		OFFSET = 0;
		CURRENT_PAGE_INDEX = 1;
		getSearchResult();
	};
	
	async function getDong(){
		let dongHTML = document.querySelector("#dong");
		dongHTML.options.length = 1;
		
		let gugunValue = document.querySelector("#gugun").value;
		
		if(gugunValue == "0" ){
			document.querySelector("#searchResult").innerHTML = "";
			return;
		}
		
		let url = "/address/dong/" + gugunValue;
		
		let response = await fetch(url);
		let data = await response.json();
		
		console.log(data);
		
		let optionHTML = ``;
		
		data.forEach(el => {
			optionHTML += `<option value=${el.dongCode}>${el.dongName}</option>`

		});
		
		dongHTML.innerHTML += optionHTML;
		
		OFFSET = 0;
		CURRENT_PAGE_INDEX = 1;
		getSearchResult();
	};
					
	function getURL(){
		let url = "/aparts/all?limit="+LIST_ROW_COUNT+"&offset="+OFFSET;
		let sidoVal = document.querySelector("#sido").value;
		let gugunVal = document.querySelector("#gugun").value;
		let dongVal = document.querySelector("#dong").value;
		let aptKeyword = document.querySelector("#aptKeyword").value;
		
		if(dongVal != "0"){
			url += "&dongCode="+dongVal;
		}
		else if(gugunVal != "0"){
			url += "&gugunCode="+gugunVal;
		}
		else if(sidoVal != "0"){
			url += "&sidoCode="+sidoVal;
		}
		
		if(aptKeyword != ""){
			url += "&aptKeyword="+aptKeyword
		}
		
		return url;
	}
	
	async function getSearchResult(){
		let url = getURL();
		
		console.log(url);
		
		let response = await fetch(url);
		let data = await response.json();
		
		console.log(data);
		
		let searchTable = document.querySelector("#searchResult");
		searchTable.innerHTML = "";
		
		data.list.forEach(el => {
			searchTable.innerHTML += `<tr data-aptCode=${el.aptCode}>
									  <td>${el.aptCode}</td>
									  <td>${el.aptName}</td>
									  <td>${el.sidoName} ${el.gugunName} ${el.dongName} ${el.jibun}</td>
									  <td>${el.buildYear}</td>
									  <td>${el.recentPrice}</td>`
		});
		TOTAL_LIST_ITEM_COUNT = data.count;
		addPagination();
		
		//history.pushState(null, null, url);
		makeListEvetHandler();
	};
	
	function makeListEvetHandler(){
		document.querySelectorAll("#searchResult tr").forEach( el =>{
			el.onclick = function(){
				let aptCode = this.getAttribute("data-aptCode");
				console.log("detailApart : " + aptCode);
				detailApart(aptCode);
			};
		});
	};
	
	async function detailApart(aptCode){
		let url = "/aparts/"+aptCode;
		
		let response = await fetch(url);
		let data = await response.json();
		
		let detailModal = new bootstrap.Modal(document.querySelector("#modalApartDetail"), {  keyboard: false } )
		detailModal.show();
		
		document.querySelector("#modalApartDetailTitle").innerText = data.aptName;
		document.querySelector("#divApartInfo").innerHTML=`${data.sidoName} ${data.gugunName} ${data.dongName} ${data.jibun} , ${data.buildYear}년 건축`;
		
		let scrollHTML = document.querySelector("#divApartDealScroll");
		
//  		data.houseDealList.forEach(el=>{
//  			scrollHTML.innerHTML+=`<a>${el}</a>`
//  		});
		
		displayMarkers(data);
	};
	function addPagination(){

		makePaginationHtml(LIST_ROW_COUNT, PAGE_LINK_COUNT, CURRENT_PAGE_INDEX, TOTAL_LIST_ITEM_COUNT, "paginationWrapper" );
	}

	function movePage(pageIndex){
		OFFSET = (pageIndex - 1) * LIST_ROW_COUNT;
		CURRENT_PAGE_INDEX = pageIndex;
		getSearchResult();
	}
	</script>
</body>
</html>